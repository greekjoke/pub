<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Cache-Control" content="max-age=3600, must-revalidate" />  
  <title>Peekaboo</title>  
  <link rel="stylesheet" href="peekaboo.css">  
  <script src="https://code.jquery.com/jquery-2.2.4.min.js"
    integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44="
    crossorigin="anonymous"></script>      
  <script src="script.js"></script>
  <script src="config.js"></script>
</head>
<body>
  <div id="card">
    <div class="main card-front">
        <img src="">  
        <div class="obstacle" data-tile="0"></div>          
    </div>    
    <div class="main card-back">      
        <img src="">
        <div class="obstacle" data-tile="1"></div>          
    </div>   
  </div>
</body>
<script>
  $(document).ready(function() {

    const cfg = window.CarouselConfig;
    const presets = cfg['dataset'];    
    let ar = false;

    presets.forEach(x => {      
      if (!x.active) return;
      if (x.target != 'peekaboo') return;
      ar = x.source;
    });

    if (!ar) return;

    let indices = [], cur = 0, nextTile = 2;
    ar.forEach(x => indices.push(indices.length));
    indices = shuffle(indices);
    
    const next = function() {
      const x = indices[cur]
      cur = (cur + 1) % indices.length;
      return ar[x];
    }

    const eImgF = $('.card-front img')[0];
    const eImgB = $('.card-back img')[0];
    const eObsF = $('.card-front .obstacle');
    const eObsB = $('.card-back .obstacle');

    eImgF.src = next();    
    eImgB.src = next();

    let tStart = null;

    $('.main').click(function() {  
      const t = new Date();      
      
      tStart = tStart || t;

      const delta = (t.getTime() - tStart.getTime()) / 1000;
      const obs = $(this).find('.obstacle');
      
      if (obs.hasClass('uncovered') || 
        (obs.hasClass('uncover') && delta > 15)) 
      {
        tStart = null;

        $('.obstacle').addClass('notransition');

        if ($('#card').hasClass('flip')) {
          $('.card-front .obstacle').removeClass('uncovered uncover');
        } else {
          $('.card-back .obstacle').removeClass('uncovered uncover');
        }        

        $('#card').toggleClass('flip');
                
        setTimeout(function() {
          $('.obstacle').removeClass('notransition');
          const e = $('#card').hasClass('flip') ? eImgF : eImgB;
          e.src = next();
          const z = $('#card').hasClass('flip') ? eObsF : eObsB;
          z.attr('data-tile', nextTile);
          nextTile = (nextTile + 1) % 3;
        }, 1000);
      } 
      else if (obs.hasClass('uncover')) 
      {
        obs.removeClass('uncover');
        obs.addClass('uncovered');
      } 
      else 
      {
        obs.addClass('uncover');
        tStart = t;
      }
    });

  });
</script>
</html>